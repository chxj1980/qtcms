<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>settings</title>
<link rel="stylesheet" type="text/css" href="css/play_back.css">
<link rel="stylesheet" href="treeview/jquery.treeview.css" />	
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/public.js"></script>
<script type="text/javascript" src="js/qframework.js" ></script>
<script type="text/javascript" src="js/calendar.js"></script>
<script type="text/javascript" src="treeview/jquery.treeview.js"></script>
<script type="text/javascript" src="treeview/jquery.treeview.edit.js"></script>
<script type="text/javascript" src="js/ocxfunction.js"></script>
<script type="text/javascript">
var oPlayBack,oBackup;
	$(function(){
		
		oPlayBack = $('#playback')[0];
		oBackup = $('#backup')[0];
		$('.hover').each(function(){
			var action = $(this).attr('class').split(' ')[0];
			addMouseStyle($(this),action);
		})
		
		$('ul.filetree').treeview();

		$('div.calendar').initCalendar();

		var listParent = $('div.dev_list');
		listParent.on('click','li:has(span.device):gt(0)',function(){
			$('div.dev_list li').removeClass('sel');
			$(this).addClass('sel');
		})

		listParent.on('dblclick','li:has(span.device):gt(0)',function(){
			searchVideo();
		})

		$('tbody.synCheckboxClick').on('click','input:checkbox',function(){
			if(oBackup.getProgress() != 0){
				return false;
			}
		})

		contentMax();
		oPlayBack.AddEventProc('RecFileInfo','RecFileInfoCallback(data)');
		oBackup.AddEventProc('RecordDirPath','getDirCallback(data)');
		oBackup.AddEventProc('BackupStatusChange','BackupStatusChangeCallback(data)');

	})///

	$(window).resize(contentMax);
	function RecFileInfoCallback(data){
		var b = true;
		var sDevName = $('div.dev_list li.sel span.device').data('data').device_name
		var uid = sDevName+'_'+data.channel+'_'+data.start+'_'+data.end;
			$('tbody.search_result tr').has(':checked').each(function(){  //正在下载的文件不被重新添加
				if(uid == $(this).attr('uid')){
					b=false;
				}
			})
			if(b){
				$('<tr uid="'+uid+'"><td><input type="checkbox" /></td><td>'+sDevName+'</td><td>'+(parseInt(data.channel)+1)+'</td><td>'+data.start+'</td><td>'+data.end+'</td><td class="progess"><div><span></span></div><a></a></td></tr>').appendTo('tbody.search_result').find('input:checkbox').data('data',data);	
			}
		
	}
	function contentMax(){
		var H = $(window).height();
		var W = $(window).width();
		var main = $('#search_result');
		if(main.width()<830){
			main.width(830);
		}
		if(main.height()<450){
			main.height(450);
		}
		main.css({
			height: H - 136,
			width: W - 238
		});
		$('#search_device').css({
			left:main.width()
		})
		$('#foot').css({
			top:main.height() + 108
		})
		$('#top').width(main.width()+238);
		$('div.dev_list').height(main.height() - $('.calendar').height()+5);
		$('#file_bottom').width(main.width());
	}

	function getDir(){ 
		oBackup.ChooseDir();
	};
	var path = '',
		now = 0,
		timer = null;
	function getDirCallback(data){ 
		now = 0;
		path = data.path;
		startDownload();
	}

	function startDownload(){
		var oList = $('#search_result input:checked')
/*		if(now >= oList.length){
			show('所有选择的文件下载完成!');
			now=0;
			return false;
		}*/
		var oDevData = $('div.dev_list li.sel span.device').data('data');
		//show(oDevData);
		var fileData = oList.eq(now).data('data');
		//alert(oDevData.address+'//'+oDevData.port+'//'+oDevData.eseeid+'//'+fileData.channel+'//'+fileData.types+'//'+fileData.start+'//'+fileData.end+'//'+path);
		if(oBackup.startBackup(oDevData.address,oDevData.port,oDevData.eseeid,fileData.channel,fileData.types,fileData.start,fileData.end,path)){
					//show('当前第'+now+'个文件下载失败!!');
					now++;
		}
		syndownload();
		/*oList = oList.filter(function(index){
			if(index == 0){ 
				var fileData = $(this).data('data');
				
			}
			return index != 0;
		})*/
	}
	function syndownload(){
		var i=0;
		var oWarp = $('#search_result tr').has('input:checked').eq(now);
			oWarp.find('a').one('click',function(){
				backupstop();
				//show('当前第'+now+'个任务已被终止!');
				return false;
			})
		timer = setInterval(function(){
			i++;
			var p = oBackup.getProgress();
			var width = p*oWarp.find('div').width()+1;
			//show('当前第'+now+'个文件的下载进度为'+p+'::所耗时间为'+i+'秒!');
			oWarp.find('span').width(width);
			/*if(p == 1){
				clearInterval(timer);
				$('#search_result tr').has('input:checked').eq(now).find('span').width(oWarp.find('div').width());
			}*/
		},1000);
		//show('正在下载当前选中文件的第'+now+'个!');
	}
	function BackupStatusChangeCallback(data){
		//show('当前文件的下载状态'+data.types);
		if(data.types != 'startBackup'){
			var oWarp = $('#search_result tr').has('input:checked').eq(now);
			oWarp.find('a').off();
			if(data.types == 'backupFinished'){ 
				oWarp.find('span').width('100%');
			}
			clearInterval(timer);
			now++;
			var oList = $('#search_result input:checked')
			if(now >= oList.length){
				//show('所有选择的文件下载完成!');
				now=0;
				$('#search_result input:checked').prop('checked',false);
				return false;
			}
			//oBackup.stopBackup();
			startDownload();
		}
	}
	function backupstop(){
			oBackup.stopBackup()
	}

</script>
<style type="text/css">
	#search_result{background: #1E1E1E; overflow-x:hidden; overflow-y:auto;}
	#file_bottom{ line-height: 22px; height: 30px; background: url(./images/backup/backup_table_bg.png) repeat-x 0 -16px; font-size: 14px;}
	#file_bottom a{display: block; height: 22px; width: 100px; background: url(./images/backup/botton.png); float: left; margin:6px; background-position: 0 0; text-align: center; color: #B5B5B6;}
	#search_result table{ border-collapse:collapse; color: #BEBEBE;width: 100%;}
	#search_result table td{ border: 1px solid #414141; text-align: center;}
	#search_result table thead td{ border: none; height: 16px; background:url(images/log/thead_bg.png) repeat-x 0 0; font-size: 14px;}
	.switch{ position: relative;}

	.progess div{ width: 250px; border:1px solid #fff; height: 14px; float: left;}
	.progess span{ background: #abcdef; height: 14px; width:0px; display: block;}
	.progess a{height:14px; width: 14px; display: block; background: red; float:left; margin:1px 8px;}
</style>
</head>

<body>
<div id="test" style=""></div>
<object type="application/cms-common-library" id="commonLibrary" style="width:100%;height:0px;"></object>
<object type="application/cms-remote-playback" id="playback" style="width:100%;height:0px;"></object>
<object type="application/cms-remote-backup" id="backup" style="width:100%;height:0px;"></object>
	<div id="top">
		<div class="top_act" id="app_top">
			<h4>DVR 客户端</h4>
			<div id="top_window_act">
				<ul>
					<li id="app_close_window"><a class="hover" style="background-position: -336px -104px;" href="javascript:;"></a></li>
					<li id="app_maxsize"><a class="hover" style="background-position: -336px -78px;" href="javascript:;"></a></li>
					<li id="app_minsize"><a class="hover" style="background-position: -336px -52px;" href="javascript:;"></a></li>
					<li id="app_userlock"><a class="toggle hover" href="javascript:;"></a></li>
				</ul>
			</div>
		</div>
		<div class="top_nav">
			<ul>
				<li><a style="width:36px;"></a>预览</li>
				<li><a style="background-position: -36px 0;"></a>回放</li>
				<li class="active"><a style="background-position: -62px 0;"></a>备份</li>
				<li><a style="background-position: -88px 0; width:36px;"></a>设置</li>
				<!-- <li><a class="hover" style="background-position: 0 -208px;" href="javascript:;">System</a></li>
				<li><a style="background-position: -124px 0;"></a>日志</li> -->
			</ul>
			<!-- <div>
				<a href="javascript:;"></a>				
				<p style="color:#000;">登陆用户:eddy</p>
			</div> -->
			</div>
		</div>
	</div>
	<div id="search_device">
		<div class="dev_list">
			<ul class="filetree" id="area_root">
				<li>
					<span class="area" id="area_0">区域_root</span>
					<ul></ul>
				</li>	
			</ul>	
	<!-- 	<ul id="area" class="filetree">
		<li><span class="area" ></span>Area
			<ul>
				<li><span class="device" >device</span>
					<ul>
						<li><span class="channel">Channel01</span></li>
						<li><span class="channel">Channel02</span></li>
						<li><span class="channel">Channel03</span></li>
						<li><span class="channel">Channel04</span></li>
					</ul>
				</li>
			</ul>
		</li>
		<li><span class="area">Area</span>
			<ul>
				<li><span class="device" >device</span>
					<ul>
						<li><span class="channel">Channel01</span></li>
						<li><span class="channel">Channel02</span></li>
						<li><span class="channel">Channel03</span></li>
						<li><span class="channel">Channel04</span></li>
						<li><span class="channel">Channel05</span></li>
						<li><span class="channel">Channel06</span></li>
						<li><span class="channel">Channel07</span></li>
						<li><span class="channel">Channel08</span></li>
					</ul>
				</li>
			</ul>
		</li> -->
		</ul>
		</div>
		<div class="calendar">
			<div class="calendar_top">
				<a class="hover" style="background-position: -240px -31px;" href="javascript:;" title="上一年"></a>
				<a class="hover" style="background-position: -160px -31px;" href="javascript:;" title="上一月"></a>
				<span class="nowDate" title="当前搜索日期"></span>
				<a class="hover" style="background-position: -0px -31px;" href="javascript:;" title="下一年"></a>
				<a class="hover" style="background-position: -80px -31px;" href="javascript:;" title="下一月"></a></div>
			<div class="calendar_days">
				<table>
					<thead>
						<tr><td style="color:red;">日</td><td>一</td><td>二</td><td>三</td><td>四</td><td>五</td><td style="color:red;">六</td></tr>
					</thead>
					<tbody>
						<tr><td style="color:red;"></td><td></td><td></td><td></td><td></td><td></td><td style="color:red;"></td></tr>
						<tr><td style="color:red;"></td><td></td><td></td><td></td><td></td><td></td><td style="color:red;"></td></tr>
						<tr><td style="color:red;"></td><td></td><td></td><td></td><td></td><td></td><td style="color:red;"></td></tr>
						<tr><td style="color:red;"></td><td></td><td></td><td></td><td></td><td></td><td style="color:red;"></td></tr>
						<tr><td style="color:red;"></td><td></td><td></td><td></td><td></td><td></td><td style="color:red;"></td></tr>
						<tr><td style="color:red;"></td><td></td><td></td><td></td><td></td><td></td><td style="color:red;"></td></tr>
					</tbody>
				</table>
			</div>
			<div class="hover seek" onclick="searchVideo();" title="开始搜索">搜索</div>
		</div>
	</div>
	<div id="search_result">
			<table>
				<thead>
					<tr><td>检查</td><td>设备名</td><td>通道</td><td>开始时间</td><td>结束时间</td><td style="width:300px;">进度</td></tr>
				</thead>
				<tbody class="search_result synCheckboxClick">
					<!-- <tr><td><input type="checkbox" /></td><td>1</td><td>2010-10-10 24:59:59</td><td>2010-10-10 24:59:59</td><td class="progess"><div><span></span></div><a></a></td></tr> -->
				</tbody>
			</table>
	</div>
	<div id="file_bottom">
		<a style="margin-left:30px;" class="hover" href="javascript:;" id="tableSelectAll">全选</a><a class="hover" onclick="backupstop();" id="tableAntiElection">停止备份</a><a class="hover" onclick="getDir();">开始备份</a>
	</div>
	<div id="foot"></div>
</body>
</html>
